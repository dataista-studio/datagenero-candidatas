<head>
    <script src="https://d3js.org/d3.v7.min.js" charset="utf-8"></script>
    <script src="https://unpkg.com/d3-sankey@0"></script>

    <style>
      .button {
        border: 1px solid black;
        cursor: pointer;
        width: 60px;
        text-align: center;
        padding: 6px 2px;
      }
    </style>
</head>

<section>
  
    <h2>F2+3: Listas -> Encabezadas por mujeres -> Competitivas encabezadas por mujeres</h2>
    <div id="viz1"></div>
    <h2>F4: distrito unico (rojo) vs. secciones (azul)</h2>
    <div id="viz2"></div>
    <h2>F5: resultados</h2>
    <div id="viz3"></div>
    <h2>Encabezamiento Senado</h2>
    <div id="viz4"></div>
  
</section>

<script src="beeswarm.js"></script>
<script>

  Promise.all([
    d3.csv('./Datos - F2 + F3 - Provincial.csv'),
    d3.csv("./Datos - F4 - Mixtos.csv"),
    d3.csv("./Datos - F5 - Nacional old.csv"),
    d3.csv("./Datos - F5 - Provincial.csv"),
    d3.csv("./Datos - Encabezamiento Senado.csv")
  ]).then((csv) => {
    const f23 = csv[0];
    const f4 = csv[1];
    const f5 = csv[2];
    const f5p = csv[3];
    const fe = csv[4];

    f23.forEach((d, i) => {
      d["listas"] = +d["listas"];
      d["listas encabezadas por mujeres"] = +d["listas encabezadas por mujeres"];
      d["listas competitivas encabezadas por mujeres"] = +d["listas competitivas encabezadas por mujeres"];
      d['% mujeres'] = (d["listas encabezadas por mujeres"] / d["listas"]).toFixed(2);
      d['% comp mujeres'] = (d["listas competitivas encabezadas por mujeres"] / d["listas"]).toFixed(2);
    });

    const data23 = f23.sort((a,b) => b['% comp mujeres'] - a['% comp mujeres']);
    data23.forEach((d, i) => {
      d.cumsum = d3.sum(data23.slice(0, i), d => d['listas']);
    });

    f4.forEach(d => {
      d["distrito unico mujeres"] = + d["distrito unico mujeres"];
      d["distrito unico total"] = + d["distrito unico total"];
      d["distrito unico mujeres porcentaje"] = + d["distrito unico mujeres porcentaje"];
      d["secciones mujeres"] = + d["secciones mujeres"];
      d["secciones total"] = + d["secciones total"];
      d["secciones mujeres porcentaje"] = + d["secciones mujeres porcentaje"];
    })

    const sortBy = "secciones mujeres porcentaje";

    const data4 = f4.sort((a, b) => b[sortBy] - a[sortBy])

    f5.forEach(d => {
      d["diputadxs"] = +d["diputadxs"];
      d["cantidad diputadas"] = +d["cantidad diputadas"];
      d["cantidad diputados"] = d["diputadxs"] - d["cantidad diputadas"];
      d["porcentaje diputadas"] = +d["porcentaje diputadas"];
      d["senadorxs"] = +d["senadorxs"];
      d["cantidad senadoras"] = +d["cantidad senadoras"];
      d["porcentaje senadoras"] = +d["porcentaje senadoras"];
    });

    f5p.forEach(d => {
      d["diputadxs"] = +d["diputadxs"];
      d["cantidad diputadas"] = +d["cantidad diputadas"];
      d["cantidad diputados"] = d["diputadxs"] - d["cantidad diputadas"];
      d["porcentaje diputadas"] = +d["porcentaje diputadas"];
      d["senadorxs"] = +d["senadorxs"];
      d["cantidad senadoras"] = +d["cantidad senadoras"];
      d["porcentaje senadoras"] = +d["porcentaje senadoras"];
    })


    const margin1 = ({ top: 10, right: 180, bottom: 10, left: 60 });

    const width1 = 800 + margin1.left + margin1.right;
    const height1 = 400;

    // Create a SVG container.
    const svg1 = d3.select("#viz1")
        .append("svg")
          .attr("width", width1)
          .attr("height", height1)
          .attr("viewBox", [0, 0, width1, height1])
          .attr("style", "max-width: 100%; height: auto; font: 10px sans-serif;");

    const g1 = svg1.append("g");

    const xSum = d3.sum(data23, d => d['listas']);

    const xScale1 = d3.scaleLinear()
        .range([0, width1 - margin1.right - margin1.left])
        .domain([0, xSum]);

    const yScale1 = d3.scaleLinear()
        .range([height1 - margin1.bottom, margin1.top])
        .domain([0,1]);

    svg1.append("g")
        .attr("transform", `translate(${margin1.left},0)`)
        .call(d3.axisLeft(yScale1).ticks(5))
        .call((g) => g.select(".domain").remove())

    const rectBg = g1.selectAll(".rect-bg")
      .data(data23)
      .join("rect")
          .attr("class", "rect-bg")
          .attr("x", d => margin1.left + xScale1(d.cumsum))
          .attr("y", yScale1(1))
          .attr("height", height1 - margin1.bottom - yScale1(1))
          .attr("width", d => xScale1(d['listas']))
          .attr("fill", "steelblue")
          // .attr("fill", d => color(d['number_of_day']))
          .attr('fill-opacity', 0.2)
          .attr("stroke", 'white')
          .attr("stroke-width", 0.5);

    const rectMg = g1.selectAll(".rect-mg")
      .data(data23)
      .join("rect")
          .attr("class", "rect-mg")
          .attr("x", d => margin1.left + xScale1(d.cumsum))
          .attr("y", d => yScale1(d['% mujeres']))
          .attr("height", d => height1 - margin1.bottom - yScale1(d['% mujeres']))
          .attr("width", d => xScale1(d['listas']))
          .attr("fill", "steelblue")
          // .attr("fill", d => color(d['number_of_day']))
          .attr('fill-opacity', 0.5)
          .attr("stroke", 'white')
          .attr("stroke-width", 0.5);

    const rectFg = g1.selectAll(".rect-fg")
      .data(data23)
      .join("rect")
          .attr("class", "rect-fg")
          .attr("x", d => margin1.left + xScale1(d.cumsum))
          .attr("y", yScale1(1))
          .attr("height", height1 - margin1.bottom - yScale1(1))
          .attr("width", d => xScale1(d['listas']))
          .attr("fill", "steelblue")
          // .attr("fill", d => color(d['number_of_day']))
          .attr('fill-opacity', 1)
          .attr("stroke", 'white')
          .attr("stroke-width", 0.5);

    const update = (stage) => {

      rectFg.each(rect => {
        const value = stage === 'first'
          ? rect['% mujeres']
          : (stage === 'last'
            ? rect['% comp mujeres']
            : 1
          )
        rect.y = yScale1(value);
        rect.height = height1 - margin1.bottom - yScale1(value)
      })

      rectFg.transition().duration(1000)
        .attr("y", d => d.y)
        .attr("height", d => d.height);

    };

    const reset = () => {
      rectFg.attr("y", yScale1(1))
        .attr("height", height1 - margin1.bottom - yScale1(1));
    }


    let clicks = 0;

    d3.select("#viz1").append("div")
      .attr("class", "button")
      .html("Next")
      .on("click", () => {
        if (clicks === 0) {
          update('first');
          clicks++;
        } else if (clicks === 1) {
          update('last');
          clicks++;
        } else {
          update('reset');
          clicks = 0;
        }
      });


    const margin2 = ({ top: 20, right: 20, bottom: 40, left: 80 });

    const width2 = 600;
    const height2 = 140;

    const yValues = f4.map(d => d.jurisdiccion)

    // Create a SVG container.
    const svg2 = d3.select("#viz2")
        .append("svg")
          .attr("width", width2)
          .attr("height", height2)
          .attr("viewBox", [0, 0, width2, height2])
          .attr("style", "max-width: 100%; height: auto; font: 10px sans-serif;");

    const g2 = svg2.append("g");

    const xScale2 = d3.scaleLinear()
        .range([margin2.left, width2 - margin2.right])
        .domain([0, 1]);

    const yScale2 = d3.scalePoint()
        .range([height2 - margin2.bottom, margin2.top])
        .domain(yValues);

    svg2.append("g")
        .attr("transform", `translate(${margin2.left},0)`)
        .call(d3.axisLeft(yScale2).ticks(5))
        .call((g) => {
          g.select(".domain").remove();
          g.selectAll(".tick line").remove();
        })

    svg2.append("g")
      .attr("transform", `translate(0, ${height2 - margin2.bottom + 20})`)
      .call(d3.axisBottom(xScale2).ticks(5))
      .call((g) => {
        g.select(".domain").remove();
      });

    const circleRadius = 5;
    const colorUnico = 'orange';
    const colorSeccion = 'steelblue';

    const lineas = svg2.selectAll(".linea")
      .data(f4)
      .join("line")
        .attr("class", "linea")
        .attr("x1", d => xScale2(d["distrito unico mujeres porcentaje"]))
        .attr("y1", d => yScale2(d["jurisdiccion"]))
        .attr("x2", d => xScale2(d["distrito unico mujeres porcentaje"]))
        .attr("y2", d => yScale2(d["jurisdiccion"]))
        .attr("stroke", "darkgrey")
        .attr("stroke-width", 1.5)

    const unicos = svg2.selectAll(".unico")
      .data(f4)
      .join("circle")
        .attr("class", "unico")
        .attr("cx", d => xScale2(d["distrito unico mujeres porcentaje"]))
        .attr("cy", d => yScale2(d["jurisdiccion"]))
        .attr("r", 0)
        .attr("fill", colorUnico);

    const secciones = svg2.selectAll(".seccion")
      .data(f4)
      .join("circle")
        .attr("class", "seccion")
        .attr("cx", d => xScale2(d["secciones mujeres porcentaje"]))
        .attr("cy", d => yScale2(d["jurisdiccion"]))
        .attr("r", 0)
        .attr("fill", colorSeccion);

    let clicks2 = 0;
    const dt = 500;

    d3.select("#viz2").append("div")
      .attr("class", "button")
      .html("Next")
      .on("click", () => {
        if (clicks2 === 0) {
          unicos.transition().duration(dt)
            .attr("r", circleRadius);
          clicks2++;
        } else if (clicks2 === 1) {
          lineas.transition().duration(dt)
            .attr("x2", d => xScale2(d["secciones mujeres porcentaje"]));
          secciones.transition().duration(dt * 2)
            .attr("r", circleRadius);
          clicks2++;
        } else {
          unicos.attr("r", 0);
          lineas.attr("x2", d => xScale2(d["distrito unico mujeres porcentaje"]));
          secciones.attr("r", 0);
          clicks2 = 0;
        }
      });

    const margin3 = ({ top: 20, right: 20, bottom: 40, left: 100 });

    const width3 = 700;
    const height3 = 300;

    // Create a SVG container.
    const svg3 = d3.select("#viz3")
        .append("svg")
          .attr("width", width3)
          .attr("height", height3)
          .attr("viewBox", [0, 0, width3, height3])
          .attr("style", "max-width: 100%; height: auto; font: 10px sans-serif;");

    const g3 = svg3.append("g");

    const x3 = 'porcentaje diputadas';
    const r3 = "cantidad diputadas";
    const rMax = Math.max(
      d3.max(f5, d => d[r3]),
      d3.max(f5p, d => d[r3])
    )

    const xScale3 = d3.scaleLinear()
        .range([margin3.left, width3 - margin3.right])
        .domain([0,100]);

    const rScale3 = d3.scaleSqrt()
      .range([2, 10])
      .domain([0, rMax])

    const beeswarm = beeswarmForce()
      .x(d => xScale3(d[x3]))
      .r(d => rScale3(d[r3]));

    const data5 = beeswarm
      .y(d => height3 / 3)
      (f5);

    const data5p = beeswarm
      .y(d => height3 * 2 / 3)
      (f5p);

    // svg3.append("g")
    //     .attr("transform", `translate(${margin3.left},0)`)
    //     .call(d3.axisLeft(yScale3).ticks(5))
        // .call((g) => g.select(".domain").remove())

    svg3.append("g")
        .attr("transform", `translate(0,${height3 - margin3.bottom})`)
        .call(d3.axisBottom(xScale3).ticks(5))
        .call((g) => g.select(".domain").remove())

    svg3.selectAll(".nacional")
      .data(data5)
      .join("circle")
        .attr("class", "nacional")
        .attr("cx", d => d.x)
        .attr("cy", d => d.y)
        .attr("r", d => d.r)
        .attr("fill", "steelblue");

    svg3.selectAll(".nacional-label")
      .data(["HCD Nacional"])
      .join("text")
        .attr("class", "nacional-label")
        .attr("x", 0)
        .attr("y", height3 / 3)
        .text(d => d)

    svg3.selectAll(".provincial")
      .data(data5p)
      .join("circle")
        .attr("class", "provincial")
        .attr("cx", d => d.x)
        .attr("cy", d => d.y)
        .attr("r", d => d.r)
        .attr("fill", "steelblue");

    svg3.selectAll(".provincial-label")
      .data(["Provincial"])
      .join("text")
        .attr("class", "provincial-label")
        .attr("x", 0)
        .attr("y", height3 * 2 / 3)
        .text(d => d);

    const field = "jurisdicción"
    const jurisdicciones = Array.from(new Set(fe.map(d => d[field])));

    const margin4 = ({ top: 10, right: 20, bottom: 10, left: 120 });

    const width4 = 500;
    const height4 = jurisdicciones.length * 40;
    const chartWidth4 = width4 - margin4.left - margin4.right;

    // Create a SVG container.
    const svg4 = d3.select("#viz4")
        .append("svg")
          .attr("width", width4)
          .attr("height", height4)
          .attr("viewBox", [0, 0, width4, height4])
          .attr("style", "max-width: 100%; height: auto; font: 10px sans-serif;");

    const g4 = svg4.append("g");

    const yScale4 = d3.scaleBand()
        .padding(0.1)
        .range([margin4.top, height4 - margin4.bottom])
        .domain(jurisdicciones);

    g4.selectAll(".lista")
      .data(["mayoria", "minoria"])
      .join("rect")
        .attr("class", "lista")
        .attr("x", d => d === 'mayoria' ? margin4.left : margin4.left + chartWidth4 * 2/3)
        .attr("y", margin4.top)
        .attr("width", d => d === "mayoria" ? chartWidth4 * 2/3 - 10 : chartWidth4 / 3)
        .attr("height", height4 - margin4.bottom - margin4.top)
        .style("fill", d => d === "mayoria" ? 'orange' : 'steelblue')
        .style("stroke", d => d === "mayoria" ? 'orange' : 'steelblue')
        .style('stroke-width', 1)
        .style("stroke-dasharray", "8 4")
        .style("stroke-opacity", 1)
        .style("fill-opacity", 0.1)

    const j = g4.selectAll(".juri")
      .data(jurisdicciones)
      .join("g")
        .attr("class", "juri")
        .attr("transform", d => `translate(0, ${yScale4(d)})`);

    j.selectAll(".label")
      .data(d => [d])
      .join("text")
        .attr("x", 0)
        .attr("y", yScale4.bandwidth() / 2 + 4)
        .text(d => d)

    const padding = 5;
    const candWidth = (chartWidth4 * 2/3 - 10 - 3 * padding) / 2;
    const minPadding = (chartWidth4 / 3 - candWidth) / 2;

    console.log(fe)

    j.selectAll(".cand")
      .data(d => fe.filter(f => f[field] === d))
      .join('rect')
      .attr("class", "cand")
        .attr("x", (d, i) => i === 0 ? margin4.left + padding : 
          (i === 1 
            ? margin4.left + 2 * padding + candWidth
            : margin4.left + chartWidth4 * 2/3 + minPadding)
        )
        .attr("y", padding)
        .attr("width", candWidth)
        .attr("height", yScale4.bandwidth() - 2 * padding)
        .style("fill", d => d.genero === '' ? 'lightgray'
          : (d.genero === "femenino" ? 'pink' : 'yellow')
        )
        .style("stroke", 'black')
        .style('stroke-width', 0.5)
        .style("stroke-opacity", 1)
        .style("fill-opacity", 1)

  })

</script>