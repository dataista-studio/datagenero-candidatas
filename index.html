<head>
    <script src="https://d3js.org/d3.v7.min.js" charset="utf-8"></script>
    <script src="https://unpkg.com/d3-sankey@0"></script>

    <style>
    </style>
</head>

<section>
  
    <div id="viz1"></div>
    <div id="viz2"></div>
    <div id="viz3"></div>
  
</section>

<script>

  Promise.all([
    d3.csv('./Datos - F2 + F3 - Provincial.csv'),
    d3.csv("./Datos - F4 - Mixtos.csv"),
    d3.csv("./Datos - F5 - Nacional old.csv")
  ]).then((csv) => {
    const f23 = csv[0];
    const f4 = csv[1];
    const f5 = csv[2];

    f23.forEach((d, i) => {
      d["listas"] = +d["listas"];
      d["listas encabezadas por mujeres"] = +d["listas encabezadas por mujeres"];
      d["listas competitivas encabezadas por mujeres"] = +d["listas competitivas encabezadas por mujeres"];
      d['% mujeres'] = (d["listas encabezadas por mujeres"] / d["listas"]).toFixed(2);
      d['% comp mujeres'] = (d["listas competitivas encabezadas por mujeres"] / d["listas"]).toFixed(2);
    });

    const data23 = f23.sort((a,b) => b['% comp mujeres'] - a['% comp mujeres']);
    data23.forEach((d, i) => {
      d.cumsum = d3.sum(data23.slice(0, i), d => d['listas']);
    });

    f4.forEach(d => {
      d["distrito unico mujeres"] = + d["distrito unico mujeres"];
      d["distrito unico total"] = + d["distrito unico total"];
      d["distrito unico mujeres porcentaje"] = + d["distrito unico mujeres porcentaje"];
      d["secciones mujeres"] = + d["secciones mujeres"];
      d["secciones total"] = + d["secciones total"];
      d["secciones mujeres porcentaje"] = + d["secciones mujeres porcentaje"];
    })

    const sortBy = "secciones mujeres porcentaje";

    const data4 = f4.sort((a, b) => b[sortBy] - a[sortBy])

    f5.forEach(d => {
      d["diputadxs"] = +d["diputadxs"];
      d["cantidad diputadas"] = +d["cantidad diputadas"];
      d["porcentaje diputadas"] = +d["porcentaje diputadas"];
      d["senadorxs"] = +d["senadorxs"];
      d["cantidad senadoras"] = +d["cantidad senadoras"];
      d["porcentaje senadoras"] = +d["porcentaje senadoras"];
    })


    const margin1 = ({ top: 10, right: 180, bottom: 10, left: 60 });

    const width1 = 800 + margin1.left + margin1.right;
    const height1 = 400;

    // Create a SVG container.
    const svg1 = d3.select("#viz1")
        .append("svg")
          .attr("width", width1)
          .attr("height", height1)
          .attr("viewBox", [0, 0, width1, height1])
          .attr("style", "max-width: 100%; height: auto; font: 10px sans-serif;");

    const g1 = svg1.append("g");

    const xSum = d3.sum(data23, d => d['listas']);

    const xScale1 = d3.scaleLinear()
        .range([0, width1 - margin1.right - margin1.left])
        .domain([0, xSum]);

    const yScale1 = d3.scaleLinear()
        .range([height1 - margin1.bottom, margin1.top])
        .domain([0,1]);

    svg1.append("g")
        .attr("transform", `translate(${margin1.left},0)`)
        .call(d3.axisLeft(yScale1).ticks(5))
        .call((g) => g.select(".domain").remove())

    const rectBg = g1.selectAll(".rect-bg")
      .data(data23)
      .join("rect")
          .attr("class", "rect-bg")
          .attr("x", d => margin1.left + xScale1(d.cumsum))
          .attr("y", yScale1(1))
          .attr("height", height1 - margin1.bottom - yScale1(1))
          .attr("width", d => xScale1(d['listas']))
          .attr("fill", "steelblue")
          // .attr("fill", d => color(d['number_of_day']))
          .attr('fill-opacity', 0.2)
          .attr("stroke", 'white')
          .attr("stroke-width", 0.5);

    const rectMg = g1.selectAll(".rect-mg")
      .data(data23)
      .join("rect")
          .attr("class", "rect-mg")
          .attr("x", d => margin1.left + xScale1(d.cumsum))
          .attr("y", d => yScale1(d['% mujeres']))
          .attr("height", d => height1 - margin1.bottom - yScale1(d['% mujeres']))
          .attr("width", d => xScale1(d['listas']))
          .attr("fill", "steelblue")
          // .attr("fill", d => color(d['number_of_day']))
          .attr('fill-opacity', 0.5)
          .attr("stroke", 'white')
          .attr("stroke-width", 0.5);

    const rectFg = g1.selectAll(".rect-fg")
      .data(data23)
      .join("rect")
          .attr("class", "rect-fg")
          .attr("x", d => margin1.left + xScale1(d.cumsum))
          .attr("y", yScale1(1))
          .attr("height", height1 - margin1.bottom - yScale1(1))
          .attr("width", d => xScale1(d['listas']))
          .attr("fill", "steelblue")
          // .attr("fill", d => color(d['number_of_day']))
          .attr('fill-opacity', 1)
          .attr("stroke", 'white')
          .attr("stroke-width", 0.5);

    const update = (stage) => {

      rectFg.each(rect => {
        const value = stage === 'first'
          ? rect['% mujeres']
          : (stage === 'last'
            ? rect['% comp mujeres']
            : 1
          )
        rect.y = yScale1(value);
        rect.height = height1 - margin1.bottom - yScale1(value)
      })

      rectFg.transition().duration(1000)
        .attr("y", d => d.y)
        .attr("height", d => d.height);

    };

    const reset = () => {
      rectFg.attr("y", yScale1(1))
        .attr("height", height1 - margin1.bottom - yScale1(1));
    }


    let clicks = 0;

    d3.select("#viz1").append("div")
      .html("Next")
      .on("click", () => {
        if (clicks === 0) {
          update('first');
          clicks++;
        } else if (clicks === 1) {
          update('last');
          clicks++;
        } else {
          update('reset');
          clicks = 0;
        }
      });


      const margin2 = ({ top: 20, right: 20, bottom: 40, left: 80 });

      const width2 = 600;
      const height2 = 140;

      const yValues = f4.map(d => d.jurisdiccion)

      // Create a SVG container.
      const svg2 = d3.select("#viz2")
          .append("svg")
            .attr("width", width2)
            .attr("height", height2)
            .attr("viewBox", [0, 0, width2, height2])
            .attr("style", "max-width: 100%; height: auto; font: 10px sans-serif;");

      const g2 = svg2.append("g");

      const xScale2 = d3.scaleLinear()
          .range([margin2.left, width2 - margin2.right])
          .domain([0, 1]);

      const yScale2 = d3.scalePoint()
          .range([height2 - margin2.bottom, margin2.top])
          .domain(yValues);

      svg2.append("g")
          .attr("transform", `translate(${margin2.left},0)`)
          .call(d3.axisLeft(yScale2).ticks(5))
          .call((g) => {
            g.select(".domain").remove();
            g.selectAll(".tick line").remove();
          })

      svg2.append("g")
        .attr("transform", `translate(0, ${height2 - margin2.bottom + 20})`)
        .call(d3.axisBottom(xScale2).ticks(5))
        .call((g) => {
          g.select(".domain").remove();
        });

      const circleRadius = 5;
      const colorUnico = 'red';
      const colorSeccion = 'steelblue';

      const lineas = svg2.selectAll(".linea")
        .data(f4)
        .join("line")
          .attr("class", "linea")
          .attr("x1", d => xScale2(d["distrito unico mujeres porcentaje"]))
          .attr("y1", d => yScale2(d["jurisdiccion"]))
          .attr("x2", d => xScale2(d["distrito unico mujeres porcentaje"]))
          .attr("y2", d => yScale2(d["jurisdiccion"]))
          .attr("stroke", "darkgrey")
          .attr("stroke-width", 1.5)

      const unicos = svg2.selectAll(".unico")
        .data(f4)
        .join("circle")
          .attr("class", "unico")
          .attr("cx", d => xScale2(d["distrito unico mujeres porcentaje"]))
          .attr("cy", d => yScale2(d["jurisdiccion"]))
          .attr("r", 0)
          .attr("fill", colorUnico);

      const secciones = svg2.selectAll(".seccion")
        .data(f4)
        .join("circle")
          .attr("class", "seccion")
          .attr("cx", d => xScale2(d["secciones mujeres porcentaje"]))
          .attr("cy", d => yScale2(d["jurisdiccion"]))
          .attr("r", 0)
          .attr("fill", colorSeccion);

      let clicks2 = 0;
      const dt = 500;

      d3.select("#viz2").append("div")
        .html("Next")
        .on("click", () => {
          if (clicks2 === 0) {
            unicos.transition().duration(dt)
              .attr("r", circleRadius);
            clicks2++;
          } else if (clicks2 === 1) {
            lineas.transition().duration(dt)
              .attr("x2", d => xScale2(d["secciones mujeres porcentaje"]));
            secciones.transition().duration(dt * 2)
              .attr("r", circleRadius);
            clicks2++;
          } else {
            unicos.attr("r", 0);
            lineas.attr("x2", d => xScale2(d["distrito unico mujeres porcentaje"]));
            secciones.attr("r", 0);
            clicks2 = 0;
          }
        });

  })

</script>