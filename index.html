<head>
    <script src="https://d3js.org/d3.v7.min.js" charset="utf-8"></script>
    <script src="https://unpkg.com/d3-sankey@0"></script>

    <style>
    </style>
</head>

<section>
  
    <div id="viz1"></div>
    <div id="viz2"></div>
    <div id="viz3"></div>
  
</section>

<script>

  Promise.all([
    d3.csv('./Datos - F2 + F3 - Provincial.csv'),
    d3.csv("./Datos - F4 - Mixtos.csv"),
    d3.csv("./Datos - F5 - Nacional old.csv")
  ]).then((csv) => {
    const f23 = csv[0];
    const f4 = csv[1];
    const f5 = csv[2];

    f23.forEach((d, i) => {
      d["listas"] = +d["listas"];
      d["listas encabezadas por mujeres"] = +d["listas encabezadas por mujeres"];
      d["listas competitivas encabezadas por mujeres"] = +d["listas competitivas encabezadas por mujeres"];
      d['% mujeres'] = (d["listas encabezadas por mujeres"] / d["listas"]).toFixed(2);
      d['% comp mujeres'] = (d["listas competitivas encabezadas por mujeres"] / d["listas"]).toFixed(2);
    });

    const data23 = f23.sort((a,b) => b['% comp mujeres'] - a['% comp mujeres']);
    data23.forEach((d, i) => {
      d.cumsum = d3.sum(data23.slice(0, i), d => d['listas']);
    })
    console.log(data23)

    f4.forEach(d => {
      d["distrito unico mujeres"] = + d["distrito unico mujeres"];
      d["distrito unico total"] = + d["distrito unico total"];
      d["distrito unico mujeres porcentaje"] = + d["distrito unico mujeres porcentaje"];
      d["secciones mujeres"] = + d["secciones mujeres"];
      d["secciones total"] = + d["secciones total"];
      d["secciones mujeres porcentaje"] = + d["secciones mujeres porcentaje"];
    })

    f5.forEach(d => {
      d["diputadxs"] = +d["diputadxs"];
      d["cantidad diputadas"] = +d["cantidad diputadas"];
      d["porcentaje diputadas"] = +d["porcentaje diputadas"];
      d["senadorxs"] = +d["senadorxs"];
      d["cantidad senadoras"] = +d["cantidad senadoras"];
      d["porcentaje senadoras"] = +d["porcentaje senadoras"];
    })


    const margin1 = ({ top: 10, right: 180, bottom: 10, left: 60 });

    const width1 = 800 + margin1.left + margin1.right;
    const height1 = 400;

    // Create a SVG container.
    const svg1 = d3.select("#viz1")
        .append("svg")
          .attr("width", width1)
          .attr("height", height1)
          .attr("viewBox", [0, 0, width1, height1])
          .attr("style", "max-width: 100%; height: auto; font: 10px sans-serif;");

    const g1 = svg1.append("g");

    const xSum = d3.sum(data23, d => d['listas']);

    const xScale1 = d3.scaleLinear()
        .range([0, width1 - margin1.right - margin1.left])
        .domain([0, xSum]);

    const yScale1 = d3.scaleLinear()
        .range([height1 - margin1.bottom, margin1.top])
        .domain([0,1]);

    // svg1.append("g")
    //     .attr("transform", `translate(${margin1.left},${height1 - margin1.bottom})`)
    //     .call(
    //         d3.axisBottom(xScale1)
    //             .tickValues(xVars.filter((val, i) => i % 5 === 0))
    //             // .tickFormat(d3.timeFormat("%b %d"))
    //     )
    //     .call(g => g.select(".domain").remove())
    //     .call(g => g.selectAll(".tick").remove())
        // .call((g) => g.append("text")
        //     .attr("x", width - margin.left)
        //     .attr("y", margin.bottom - 4)
        //     .attr("fill", "currentColor")
        //     .attr("text-anchor", "end")
        //     .text(`${x} â†’`));

    svg1.append("g")
        .attr("transform", `translate(${margin1.left},0)`)
        .call(d3.axisLeft(yScale1).ticks(5))
        .call((g) => g.select(".domain").remove())

    const rectBg = g1.selectAll(".rect-bg")
      .data(data23)
      .join("rect")
          .attr("class", "rect-bg")
          .attr("x", d => margin1.left + xScale1(d.cumsum))
          .attr("y", yScale1(1))
          .attr("height", height1 - margin1.bottom - yScale1(1))
          .attr("width", d => xScale1(d['listas']))
          .attr("fill", "steelblue")
          // .attr("fill", d => color(d['number_of_day']))
          .attr('fill-opacity', 0.2)
          .attr("stroke", 'white')
          .attr("stroke-width", 0.5);

    const rectMg = g1.selectAll(".rect-mg")
      .data(data23)
      .join("rect")
          .attr("class", "rect-mg")
          .attr("x", d => margin1.left + xScale1(d.cumsum))
          .attr("y", d => yScale1(d['% mujeres']))
          .attr("height", d => height1 - margin1.bottom - yScale1(d['% mujeres']))
          .attr("width", d => xScale1(d['listas']))
          .attr("fill", "steelblue")
          // .attr("fill", d => color(d['number_of_day']))
          .attr('fill-opacity', 0.5)
          .attr("stroke", 'white')
          .attr("stroke-width", 0.5);

    const rectFg = g1.selectAll(".rect-fg")
      .data(data23)
      .join("rect")
          .attr("class", "rect-fg")
          .attr("x", d => margin1.left + xScale1(d.cumsum))
          .attr("y", yScale1(1))
          .attr("height", height1 - margin1.bottom - yScale1(1))
          .attr("width", d => xScale1(d['listas']))
          .attr("fill", "steelblue")
          // .attr("fill", d => color(d['number_of_day']))
          .attr('fill-opacity', 1)
          .attr("stroke", 'white')
          .attr("stroke-width", 0.5);

    const update = (stage) => {

      rectFg.each(rect => {
        const value = stage === 'first'
          ? rect['% mujeres']
          : (stage === 'last'
            ? rect['% comp mujeres']
            : 1
          )
        rect.y = yScale1(value);
        rect.height = height1 - margin1.bottom - yScale1(value)
      })

      rectFg.transition().duration(1000)
        .attr("y", d => d.y)
        .attr("height", d => d.height);

    };

    const reset = () => {
      rectFg.attr("y", yScale1(1))
        .attr("height", height1 - margin1.bottom - yScale1(1));
    }


    let clicks = 0;

    d3.select('body').append("div")
      .html("Next")
      .on("click", () => {
        console.log('here')
        if (clicks === 0) {
          update('first');
          clicks++;
        } else if (clicks === 1) {
          update('last');
          clicks++;
        } else {
          update('reset');
          clicks = 0;
        }
      })

  })

</script>